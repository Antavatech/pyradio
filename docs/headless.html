<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>PyRadio Headless Operation</title>
    <style> 
    body {padding: 2em;} 
    @media screen and (max-width: 770px) { 
        body {padding: 10px;} 
    }
    body {max-width: 750px; margin: auto;} 
    h2 {margin-top: 2.5em; border-bottom:1px solid SaddleBrown; color: SaddleBrown;} 
    h3 {margin-top: 2em; color: SaddleBrown; text-decoration: underline SaddleBrown} 
    h4 {margin: 2em 0 1em 0; color: SaddleBrown; font-size: 1em;} 
    h4:before {content: "# "; font-weight: bold; vertical-align: middle;} 
    h5 {margin: 2em 0 1em 0; color: SaddleBrown; font-size: 1em;;} 
    h5:before {content: "## "; font-weight: bold; vertical-align: middle;} 
    h1, h2, h3, h4, h5 {margin-left: -.7em;} 
    STRONG {color: SaddleBrown;} 
    dl {margin: 2em;} 
    dd {margin: 1em;} 
    dt {font-weight: bold;} 
    TABLE {border: 1px solid SaddleBrown; border-collapse: collapse; margin-left: auto; margin-right: auto; border-radius: 5px; -moz-border-radius: 5px; border-collapse:separate; box-shadow: 5px 5px 15px #888888;} 
    TH {text-align: left; vertical-align: top; padding: 5px;color: SaddleBrown;border: 1px solid SaddleBrown; background-color: SaddleBrown; color: white;} 
    TD {text-align: left; vertical-align: top; padding: 5px 10px;border: 1px solid SaddleBrown;} 
    pre { background-color: rgba(245, 245, 245, 1); color: #474747; padding: 1.5em; border: 1px solid #C7C7C7; border-radius: 5px; -moz-border-radius: 5px; -webkit-border-radius: 5px; overflow: auto; box-shadow: 5px 5px 15px #C7C7C7;} 
    .task-list {list-style-type: none; padding: 0; margin: 0 0 0 1em ;} 
    img{display: block; margin-left: auto; margin-right: auto; max-width: 750px; width: 100%;  background:transparent; padding:3px; border:1px solid #999999; border-radius: 5px; -moz-border-radius: 5px; -webkit-border-radius: 5px; box-shadow:5px 5px 15px #888888;} 
    .indented {text-indent: -1.5em; padding-left: 1.5em; margin-left: 1em;} 
    a{ color: SaddleBrown;}
a:visited{color: SaddleBrown;}
</style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header id="title-block-header">
</header>
<h1 style="color: SaddleBrown" id="pyradio-headless-operation">PyRadio Headless Operation</h1>
<h2 id="table-of-contents">Table of Contents <span style="padding-left: 10px;"><sup style="font-size: 50%"><a href="#" title="Go to top of the page">Top</a></sup></span></h2>
<!-- vim-markdown-toc Marked -->
<ul>
<li><a href="#goal">Goal</a>
<ul>
<li><a href="#usage">Usage</a></li>
<li><a href="#how-it-works">How it works</a></li>
</ul></li>
<li><a href="#installation">Installation</a>
<ul>
<li><a href="#systemd">systemd</a></li>
</ul></li>
<li><a href="#using-screen-instead-of-tmux">Using screen instead of tmux</a></li>
</ul>
<!-- vim-markdown-toc -->
<p class="indented">[ <a href="index.html#installation">Return to main doc</a> ]</p>
<h2 id="goal">Goal <span style="padding-left: 10px;"><sup style="font-size: 50%"><a href="#" title="Go to top of the page">Top</a></sup></span></h2>
<p>This is a document that provides info on running <strong>PyRadio</strong> in <em>headless</em> mode (well, kind of), on a Linux, BSD, or Pi system.</p>
<p>Now, <strong>PyRadio</strong> is a <strong>terminal application</strong>; it actually <strong>needs</strong> a terminal to run. But there is a way to make it run on a “terminal” and at the same time run in the background, being “invisible” so to speak, or run as a weird kind of a daemon; the way to do that is run it in a <strong>tmux detached session</strong> or a <strong>screen detached session</strong>.</p>
<p><strong>tmux</strong> man page reads:</p>
<p>“<strong>tmux</strong> is a terminal multiplexer: it enables a number of terminals to be created, accessed, and controlled from a single screen. tmux may be <strong>detached from a screen</strong> and continue running in the background, then later reattached.”</p>
<p><strong>screen</strong> man page reads:</p>
<p>“<strong>Screen</strong> is a full-screen window manager that multiplexes a physical terminal between several processes (typically interactive shells)… Programs continue to run when their window is currently not visible and even when the whole screen session <strong>is detached from the user’s terminal</strong>.”</p>
<p><strong>PyRadio</strong> users <a target="_blank" href="https://github.com/Wikinaut">Wikinaut</a> and <a target="_blank" href="https://github.com/aleksandr-sabitov">aleksandr-sabitov</a> on <a target="_blank" href="https://github.com/coderholic/pyradio/issues/184">github</a> have come up with the idea to use this approach to run the application on their headless Raspberry Pi, so kudos to them!</p>
<h3 id="usage">Usage</h3>
<p>After the program is started, the only way (well, not really, more on this below) to interact with it is through its integrated web server.</p>
<p>The web server can be accessed either through a terminal (address <strong>http://ip:port</strong>) using wget or curl, or through a web browser (address <strong>http://ip:port/html</strong>).</p>
<p>The ip and port will be set using the <strong>–headless</strong> command line option.</p>
<p>The ip can either be:</p>
<ol type="1">
<li><strong>localhost</strong><br />
The server will be accessible only by programs running in the system. The ip is 127.0.0.1.</li>
<li><strong>lan</strong><br />
The server will be accessible by any system on the LAN. The ip is the one assigned to the network interface of the system.</li>
</ol>
<p>For example: - using <strong>–headless lan:12345</strong><br />
will make the web server listen to the network interface IP address, port 12345. - using <strong>–headless localhost:23456</strong><br />
will make the web server listen to 127.0.0.1, port 23456 - using <strong>–headless auto</strong><br />
will make the web server listen to 127.0.0.1, port 11111; this is the default and fallback configuration.</p>
<p>To get the server ip and port, execute on a terminal</p>
<pre>pyradio --addr</pre>
<p>Which will return something like:</p>
<pre>PyRadio Remote Control Server
  Headless server
    Text address: http://127.0.0.1:11111
    HTML address: http://127.0.0.1:11111/html</pre>
<p>If both a “headless” and a normal instance of <strong>PyRadio</strong> is running, you will get something like this:</p>
<pre>PyRadio Remote Control Server
  Headless server
    Text address: http://127.0.0.1:11111
    HTML address: http://127.0.0.1:11111/html
  Server
    Text address: http://127.0.0.1:9998
    HTML address: http://127.0.0.1:9998/html</pre>
<h3 id="how-it-works">How it works</h3>
<p>When <strong>PyRadio</strong> is executed with the <strong>–headles</strong> command line option, it will basically start the web server and wait for connections.</p>
<p>To make it less memory hungry, the default (aka “<em>dark</em>” theme) will be loaded, and access to themes and the configuration window will be restricted.</p>
<p>Additionally, it will not create a “<em>session lock file</em>”, so that other instances of the program can be executed normally (in a terminal), and be able to function properly.</p>
<p>It will create a “headless server lock file”, though, so that a) we cannot start a second headless server, and b) we can get info about the server running.</p>
<p>To get access to the program, execute:</p>
<pre>tmux attach-session -t pyradio-session</pre>
<p>To detach the session press <strong>C-b d</strong> (default key binding).</p>
<h2 id="installation">Installation <span style="padding-left: 10px;"><sup style="font-size: 50%"><a href="#" title="Go to top of the page">Top</a></sup></span></h2>
<p style="margin: 1.5em 4em 0 4em; text-indent: -2.5em;"><strong>Note:</strong> the instructions in this section focus on using <strong>tmux</strong>; differences regarding using <strong>screen</strong> will follow.</p>
<p>By the term “installation”, we mean that we set up things in such a way, that after we log into the system, we find <strong>PyRadio</strong> ready to accept connections.</p>
<p>So, the installation can be as easy as adding a line in a configuration file (or the startup section of the <em>desktop environment</em>) or as hard as adding a system service.</p>
<p style="margin: 1.5em 4em 0 4em; text-indent: -2.5em;"><strong>Note:</strong> All commands start by removing the “headless server lock file”, just in case <strong>PyRadio</strong> was not able to remove it itself the last time it terminated… this should be acceptable, since these commands are supposed to be running once, at system boot.</p>
<p>For example, if <strong>bash</strong> is the default shell, this would do the trick:</p>
<pre>echo &quot;rm /home/spiros/.config/pyradio/data/server-headless.txt 2&gt;/dev/null
      /usr/bin/tmux new-session \
        -dA -s pyradio-session /home/spiros/.local/bin/pyradio \
        --headless auto&quot; &gt;&gt; ~/.profile</pre>
<p>In case a <em>Window manager</em> is used, adding a line in its <strong>autostart</strong> file would be enough. For example, this would work for <strong>openbox</strong>:</p>
<pre>echo &quot;(sleep 10; rm /home/spiros/.config/pyradio/data/server-headless.txt 2&gt;/dev/null; /usr/bin/tmux new-session -dA -s pyradio-session /home/spiros/.local/bin/pyradio --headless auto)&quot; &gt;&gt; ~/.config/openbox/autostart</pre>
<p>And so on, and so forth…</p>
<h3 id="systemd">systemd</h3>
<p>The first thing you do is create the log file:</p>
<pre>touch ~/pyradio.log</pre>
<p>Then create the start file:</p>
<pre>mkdir ~/.local/bin
echo &quot;#!/bin/bash&quot; &gt; ~/.local/bin/start-headless-pyradio.sh
echo &quot;rm /home/spiros/.config/pyradio/data/server-headless.txt 2&gt;/dev/null&quot; &gt;&gt; ~/.local/bin/start-headless-pyradio.sh
echo &quot;/usr/bin/tmux new-session -dA -s pyradio-session /home/spiros/.local/bin/pyradio --headless auto&quot; &gt;&gt; ~/.local/bin/start-headless-pyradio.sh
chmod +x ~/.local/bin/start-headless-pyradio.sh</pre>
<p>Finally create the service:</p>
<p>File /lib/systemd/system/pyradio.service</p>
<pre>[Unit]
Description=PyRadio Service
After=multi-user.target

[Service]
Type=forking
User=spiros
Environment=&quot;XDG_RUNTIME_DIR=/run/user/1000&quot;
Environment=&quot;PULSE_RUNTIME_PATH=/run/user/1000/pulse/&quot;
StandardOutput=append:/home/spiros/pyradio.log
StandardError=append:/home/spiros/pyradio.log
ExecStart=/home/spiros/.local/bin/start-headless-pyradio.sh
ExecStop=/usr/bin/tmux kill-session -t pyradio-session

[Install]
WantedBy=multi-user.target</pre>
<p>Then execute:</p>
<pre>$ sudo chmod 644 /lib/systemd/system/pyradio.service
$ sudo systemctl daemon-reload
$ sudo systemctl enable pyradio # enabling the autostart on every boot</pre>
<p>And get the status:</p>
<pre>$ sudo systemctl status pyradio
● pyradio.service - PyRadio Service
     Loaded: loaded (/usr/lib/systemd/system/pyradio.service; enabled; preset: disabled)
     Active: active (running) since Fri 2023-12-01 11:33:02 EET; 2min 47s ago
    Process: 10829 ExecStart=/home/spiros/.local/bin/start-headless-pyradio.sh (code=exited, status=0/SUCCESS)
   Main PID: 10831 (tmux: server)
      Tasks: 23 (limit: 9395)
     Memory: 103.3M
        CPU: 2.629s
     CGroup: /system.slice/pyradio.service
             ├─10831 /usr/bin/tmux new-session -dA -s pyradio-session /home/spiros/.local/bin/pyradio --headless auto
             ├─10941 /home/spiros/.local/pipx/venvs/pyradio/bin/python /home/spiros/.local/bin/pyradio --headless auto
             └─11126 mpv --no-video --quiet https://icecast.walmradio.com:8443/christmas --input-ipc-server=/tmp/mpvsocket.10941 --profile=pyradio

Dec 01 11:33:02 py systemd[1]: Starting PyRadio Service...
Dec 01 11:33:02 py systemd[1]: Started PyRadio Service.</pre>
<p>The service can be stopped:</p>
<pre>sudo systemctl stop pyradio</pre>
<p>And this is its state:</p>
<pre>$ sudo systemctl status pyradio
○ pyradio.service - PyRadio Service
     Loaded: loaded (/usr/lib/systemd/system/pyradio.service; enabled; preset: disabled)
     Active: inactive (dead) since Fri 2023-12-01 11:37:51 EET; 21s ago
   Duration: 4min 49.355s
    Process: 10829 ExecStart=/home/spiros/.local/bin/start-headless-pyradio.sh (code=exited, status=0/SUCCESS)
    Process: 11353 ExecStop=/usr/bin/tmux kill-session -t pyradio-session (code=exited, status=0/SUCCESS)
   Main PID: 10831 (code=exited, status=0/SUCCESS)
        CPU: 4.097s

Dec 01 11:33:02 py systemd[1]: Starting PyRadio Service...
Dec 01 11:33:02 py systemd[1]: Started PyRadio Service.
Dec 01 11:37:51 py systemd[1]: Stopping PyRadio Service...
Dec 01 11:37:51 py systemd[1]: pyradio.service: Deactivated successfully.
Dec 01 11:37:51 py systemd[1]: Stopped PyRadio Service.
Dec 01 11:37:51 py systemd[1]: pyradio.service: Consumed 4.097s CPU time.</pre>
<h2 id="using-screen-instead-of-tmux">Using screen instead of tmux <span style="padding-left: 10px;"><sup style="font-size: 50%"><a href="#" title="Go to top of the page">Top</a></sup></span></h2>
<p>The difference is actually the command to start the detached session.</p>
<p>This means that you just have to replace the</p>
<pre>/usr/bin/tmux new-session -dA -s pyradio-session</pre>
<p>part, with</p>
<pre>/usr/bin/screen -U -S pyradio-session -d -m</pre>
<p>in the commands above.</p>
<p>To get access to the program, you’d execute:</p>
<pre>screen -r pyradio-session</pre>
<p>and press “<strong>C-a d</strong>” to detach it again.</p>
<p>Other than that, the behavior should be the same.</p>
</body>
</html>
